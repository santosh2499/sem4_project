{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row g-4">
        <!-- Total Expenses Card -->
        <div class="col-md-4">
            <div class="card text-white bg-primary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Total Expenses</h5>
                    <h2 class="card-text">₹{{ total_expense|default(0)|round(2) }}</h2>
                </div>
            </div>
        </div>

        <!-- Recent Transactions Card -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Recent Transactions</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            {% for t in recent_transactions %}
                            <tr>
                                <td>{{ t[2] }}</td>
                                <td>₹{{ t[3] }}</td>
                                <td>{{ t[4][:10] }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-6 text-center">
            <div class="card shadow-sm p-4">
                <h5 class="mb-3">Expense Distribution by Category</h5>
                <canvas id="categoryChart" width="350" height="350"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ category_totals|map(attribute='0')|list|tojson }};
    const dataValues = {{ category_totals|map(attribute='1')|list|tojson }};
    const total = dataValues.reduce((sum, val) => sum + val, 0);

    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: dataValues,
                backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff']
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
